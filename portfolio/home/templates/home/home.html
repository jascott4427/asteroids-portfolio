<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Asteroids Start</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: black;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    {% load static %}
    <canvas id="gameCanvas"></canvas>

    <script>

        // TODO: Fix music not playing. make sure to start on new game and not on load of gameloop
        // TODO: Add asteroids
        // TODO: add animations for ships and bullets
        // TODO: add explosion animations and fx
        // TODO: add point system
        // TODO: add game logic and spawn system
        // TODO: collision detection system
        // TODO: add arcade style main menu
        // TODO: add background to main menu

        // =============================
        // Constants
        // =============================
        // Background
        const NUM_STARS = 200;   // number of stars
        const MAX_STAR_SIZE = 3; // maximum radius of stars

        // Player
        const PLAYER_SIZE = 60;     // ship size in pixels
        const SHIP_ACC = 200;       // pixels/s^2
        const FRICTION = 0.8;       // cooeficient of friction
        const SHIP_VEL = 500;       // pixels / second
        const SHIP_HIT_RADIUS = 25; // pixels

        // Bullets
        const BULLET_VEL = 600;         // pixels/second
        const BULLET_DUR = 2;           // seconds
        const BULLET_SIZE = 20;         // pixels
        const BULLET_HIT_RADIUS = 10;   // pixels

        // Asteroids
        const ROIDS = {
            LARGE: {size: 120, hitRadius: 60, points: 20},
            MEDIUM: {size: 40, hitRadius: 40, points: 50},
            SMALL: {size: 20, hitRadius: 20, points: 100}
        };
        const ROID_MAX_V = 300;
        const ROID_MIN_V = 50;
        const ROID_MAX_W = 2.0;
        const ROID_MIN_W = 0.5;

        // Game
        const INIT_ROIDS = 4;
        

        // =============================
        // Setup Canvas
        // =============================
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // =============================
        // Sound Manager
        // =============================
        class SoundManager {
            constructor() {
                this.sounds = {};
                this.loopingSounds = {};
                this.music = null;
                this.musicVolume = 0.5;
                this.soundVolume = 0.7;
                this.musicPlaying = false;
            }

            loadSound(name, path){
                const audio = new Audio(path);
                audio.volume = this.soundVolume;
                audio.preload = 'auto';
                audio.load();
                this.sounds[name] = audio;
                console.log(`Loaded sound: ${name}`);
            }

            playSound(name){
                if (this.sounds[name]) {
                    const sound = this.sounds[name].cloneNode();
                    sound.volume = this.soundVolume;
                    sound.play().catch(e => console.log('Could not play sound ${name}:', e))
                }
            }

            playLoopingSound(name) {
                if (this.sounds[name] && !this.loopingSounds[name]) {
                    const sound = this.sounds[name].cloneNode();
                    sound.volume = this.soundVolume;
                    sound.loop = true;
                    sound.play().then(() => {this.loopingSounds[name] = sound}).catch(e => console.log('Could not play sound ${name}:', e));
                }
            }

            stopLoopingSound(name) {
                if (this.loopingSounds[name]) {
                    this.loopingSounds[name].pause();
                    this.loopingSounds[name].currentTime = 0;
                    delete this.loopingSounds[name];
                }
            }

            stopAllLoopingSounds() {
                Object.keys(this.loopingSounds).forEach(name => {this.stopLoopingSound(name)});
            }

            playMusic(path){
                if (this.music) {
                    this.music.pause();
                }
                this.music = new Audio(path);
                this.music.volume = this.musicVolume;
                this.music.loop = true;

                this.music.play().then(() => {this.musicPlaying = true}).catch(e => console.log("Could not play music:", e));
            }

            stopMusic(){
                if (this.music) {
                    this.music.pause();
                    this.musicPlaying = false;
                }
            }

            setSoundVolume(vol){
                this.soundVolume = Math.max(0, Math.min(1, vol));
                Object.values(this.sounds).forEach(sound => {sound.volume = this.soundVolume});
            }

            setMusicVolume(vol){
                this.musicVolume = Math.max(0, Math.min(1, vol));
                if (this.music) {
                    this.music.volume = this.musicVolume;
                }
            }

            toggleMusic(){
                if (this.musicPlaying) {
                    this.stopMusic();
                }
                else if (this.music) {
                    this.music.play();
                    this.musicPlaying = true;
                }
            }
        }

        // =============================
        // Start Screen Class
        // =============================
        class StartScreen {
            constructor() {
                this.visible = true;
            }

            draw() {
                if (!this.visible) return;

                // Semi-transparent overlay
                ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Title
                ctx.fillStyle = "white";
                ctx.font = "48px Arial";
                ctx.textAlign = "center";
                ctx.fillText("ASTEROIDS", canvas.width/2, canvas.height/2 - 50);

                // Instructions
                ctx.font = "24px Arial";
                ctx.fillText("Click or press any key to start", canvas.width/2, canvas.height/2 + 50);
                ctx.fillText("Use Arrow Keys to move, Space to shoot", canvas.width/2, canvas.height/2 + 100);
            }

            hide() {
                this.visible = false;
            }
        }
        // =============================
        // Background class
        // =============================
        class Background {
            constructor() {
                this.stars = [];
                for (let i = 0; i < NUM_STARS; i++) {
                    this.stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        r: Math.random() * MAX_STAR_SIZE + 1,
                        alpha: Math.random() * 0.5 + 0.5
                    });
                }
            }

            draw() {
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                for (let star of this.stars) {
                    ctx.globalAlpha = star.alpha;
                    ctx.fillStyle = "white";
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
            }
        }

        // =============================
        // Player class
        // =============================
        class Player {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.angle = 0; // facing up
                this.vx = 0;
                this.vy = 0;
                this.hitRadius = SHIP_HIT_RADIUS;

                // sound states
                this.isThrusting = false;
                this.thrustSound = null;

                this.img = new Image();
                this.img.src = "{% static 'Starfighter Files/sprites/Ships/ship-a/ship-a1.png' %}";
                this.ready = false;
                this.img.onload = () => { this.ready = true; }

                // Physics constants
                this.acc = SHIP_ACC;       // pixels per second^2
                this.angVel = Math.PI; // rad/s
                this.friction = FRICTION;    // per second
                this.vel = SHIP_VEL;     // pixels per second
                this.hitboxActive = true // On for debugging
            }

            update(keys, dt, soundManager) {                
                // Rotation
                if (keys["ArrowLeft"] || keys["KeyA"]) this.angle -= this.angVel * dt;
                if (keys["ArrowRight"] || keys["KeyD"]) this.angle += this.angVel * dt;

                // Thrust
                // Audio loading
                const wasThrusting = this.isThrusting;
                if (keys["ArrowUp"] || keys["KeyW"]) {
                    this.isThrusting = true;
                }
                else {
                    this.isThrusting = false;
                }
                if (this.isThrusting && !wasThrusting) {
                    soundManager.playLoopingSound('thrust');
                }
                else if (!this.isThrusting && wasThrusting) {
                    soundManager.stopLoopingSound('thrust');
                }
                // Motion handling of thrust
                if (this.isThrusting) {
                    const thrustAngle = this.angle;
                    this.vx += Math.cos(thrustAngle) * this.acc * dt;
                    this.vy += Math.sin(thrustAngle) * this.acc * dt;
                }

                // Apply friction
                this.vx *= Math.pow(this.friction, dt);
                this.vy *= Math.pow(this.friction, dt);

                // Limit max velocity
                const speed = Math.sqrt(this.vx*this.vx + this.vy*this.vy);
                if (speed > this.vel) {
                    const scale = this.vel / speed;
                    this.vx *= scale;
                    this.vy *= scale;
                }

                // Update position
                this.x += this.vx * dt;
                this.y += this.vy * dt;

                // Screen wrap
                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                if (!this.ready) return;
                // player 
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle + Math.PI/2);
                ctx.drawImage(this.img, -PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE);

                // hitbox
                if (this.hitboxActive) {
                    ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                    ctx.beginPath();
                    ctx.arc(0, 0, this.hitRadius, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        class Bullet {
            constructor(originX, originY, angle, hitbox_status) {
                this.x = originX;
                this.y = originY;
                this.angle = angle;
                this.dur = BULLET_DUR;
                this.vel = BULLET_VEL;
                this.hitboxActive = hitbox_status
                this.hitRadius = BULLET_HIT_RADIUS;
                this.vx = 0;
                this.vy = 0;
                this.size = BULLET_SIZE;

                this.img = new Image();
                this.img.src = "{% static 'Starfighter Files/sprites/FX/bullet/bullet1.png' %}";
                this.ready = false;
                this.img.onload = () => { this.ready = true; }
            }

            update(dt) {
                // Calculate trajectory 
                this.vx = Math.cos(this.angle) * this.vel;
                this.vy = Math.sin(this.angle) * this.vel;

                // Update position
                this.x += this.vx * dt;
                this.y += this.vy * dt;

                // Update duration
                this.dur -= dt;

                // Screen wrap
                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                if (!this.ready) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.drawImage(this.img, -this.size/2, -this.size/2, this.size, this.size);

                // hitbox
                if (this.hitboxActive) {
                    ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                    ctx.beginPath();
                    ctx.arc(0, 0, this.hitRadius, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }  
        
        class Roid {
            constructor(roidSize, x, y, theta, v, w, hitboxStatus) {
                this.roidSize = roidSize;
                this.x = x;
                this.y = y;
                this.angle = theta;
                this.v = v;
                this.vx = Math.cos(this.angle) * v;
                this.vy = Math.sin(this.angle) * v;
                this.w = w;
                this.hitRadius = 0;
                this.hitboxActive = hitboxStatus;
                this.size = 0;

                this.img = new Image();
                if (this.roidSize == 'large') {
                    this.img.src = "{% static 'Starfighter Files/sprites/Asteroids/big-c.png' %}";
                    this.hitRadius = ROIDS.LARGE.hitRadius;
                    this.size = ROIDS.LARGE.size;
                    this.points = ROIDS.LARGE.points;
                } else if (this.roidSize == 'med') {
                    this.img.src = "{% static 'Starfighter Files/sprites/Asteroids/med-c.png' %}";
                    this.hitRadius = ROIDS.MEDIUM.hitRadius;
                    this.size = ROIDS.MEDIUM.size;
                    this.points = ROIDS.MEDIUM.points;
                } else if (this.roidSize == 'small') {
                    this.img.src = "{% static 'Starfighter Files/sprites/Asteroids/small-c.png' %}";
                    this.hitRadius = ROIDS.SMALL.hitRadius;
                    this.size = ROIDS.SMALL.size;
                    this.points = ROIDS.SMALL.points;
                }
                this.ready = false;
                this.img.onload = () => { this.ready = true; }
            }

            update(dt) {                
                // Calculate position
                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.angle += this.w * dt;

                // Screen wrap
                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                if (!this.ready) return;
                // player 
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle + Math.PI/2);
                ctx.drawImage(this.img, -this.size/2, -this.size/2, this.size, this.size);

                // hitbox
                if (this.hitboxActive) {
                    ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                    ctx.beginPath();
                    ctx.arc(0, 0, this.hitRadius, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        class CollisionManager {
            constructor(bullets, roids, player) {
                this.bullets = bullets;
                this.roids = roids;
                this.player = player;
            }

            isPlayerDead() {
                // TODO

            }

            checkCollision() {
                // TODO

            }


        }

        class SpatialGrid {
            constructor(cellSize) {
                this.cellSize = cellSize;
                this.grid = new Map();
            }

            getKey(x, y) {
                // TODO
            }

            insert(object) {
                // TODO

            }

            getNearby(object) {
                // TODO

            }

            clear() {
                this.grid.clear();
            }
        }

        // =============================
        // Key listener
        // =============================
        const keys = {};
        window.addEventListener("keydown", e => keys[e.code] = true);
        window.addEventListener("keyup", e => keys[e.code] = false);

        // =============================
        // GameLoop class
        // =============================
        class GameLoop {
            constructor() {
                // Initialize classes
                this.background = new Background();
                this.player = new Player(canvas.width/2, canvas.height/2);
                this.soundManager = new SoundManager();
                this.startScreen = new StartScreen();

                // load sounds
                // soundManager.loadSound('name', '{% static "path\to\shoot.wav" %}');
                this.soundManager.loadSound('thrust', '{% static "Starfighter Files/Audio/thrust.wav" %}');
                this.soundManager.loadSound('explosion', '{% static "Starfighter Files/Audio/Explosion.wav" %}');
                this.soundManager.loadSound('shoot', '{% static "Starfighter Files/Audio/Laser_Shoot.wav" %}');

                // Game state
                this.bullets = [];
                this.roids = [];
                this.gameStarted = false
                this.currentWave = 0;
                this.roidsDestroyed = 0;

                // Timing
                this.lastTime = performance.now();
                this.lastSpaceBar = false;

                this.setupStartHandlers();
            }

            setupStartHandlers() {
                const startGame = () => {
                    if (!this.gameStarted) {
                        this.gameStarted = true;
                        this.startScreen.hide();
                        this.startNewWave()
                        this.soundManager.playMusic('{% static "Starfighter Files/Music/asteroids-383043.mp3"%}');
                    }
                };

                canvas.addEventListener('click', startGame);
                window.addEventListener('keydown', startGame);
            }

            startNewWave() {
                // Clear wave variables
                this.currentWave++;
                this.roids = [];
                this.roidsDestroyed = 0;

                // Calculate number of roids to spawn
                const roidCount = Math.floor(INIT_ROIDS * Math.pow(1.5, this.currentWave - 1));

                console.log(`Starting wave ${this.currentWave} with ${this.roidCount} asteroids`);

                for (let i = 0; i<roidCount; i++) {
                    this.spawnRoid('large');
                }
            }

            spawnRoid(size) {
                // Find rand posiiton away from player
                let x, y;
                const minDistFromPlayer = 150;

                do {
                    x = Math.random() * canvas.width;
                    y = Math.random() * canvas.height;
                } while (Math.hypot(x - this.player.x, y - this.player.y) < minDistFromPlayer);

                // Random Velocity
                const speed = ROID_MIN_V + Math.random() * (ROID_MAX_V - ROID_MIN_V);
                const angle = Math.random() * Math.PI * 2;

                // Random Spin
                const w = (Math.random() * (ROID_MAX_W - ROID_MIN_W) + ROID_MIN_W) * (Math.random() > 0.5 ? 1 : -1);
                
                // Create roid
                const roid = new Roid(size, x, y, angle, speed, w, this.player.hitboxActive);
                this.roids.push(roid);
            }

            checkWaveComplete() {
                if (this.roids.length === 0 && this.gameStarted) {
                    console.log(`Wave ${this.currentWave} complete! Starting next wave ...`);
                    setTimeout(() => {this.startNewWave();}, 1000);
                }
            }

            updateRoids(dt) {
                for (let i = this.roids.length - 1; i >= 0; i--) {
                    this.roids[i].update(dt);
                }
            }

            drawRoids() {
                for (let roid of this.roids) {
                    roid.draw();
                }
            }

            drawWaveInfo() {
                ctx.fillStyle = "white";
                ctx.font = "16px Arial";
                ctx.textAlign = "left";
                ctx.fillText(`Wave: ${this.currentWave} | Asteroids: ${this.roids.length}`, 10, 30);
            }

            draw = (currentTime) => {
                // Time
                const dt = (currentTime - this.lastTime) / 1000; // seconds
                this.lastTime = currentTime;

                // Clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Start Screen
                if (!this.gameStarted) {
                    this.startScreen.draw();
                    requestAnimationFrame(this.draw);
                    return;
                }

                // Draw background layers
                this.background.draw();

                // Hnadle player drawing
                this.player.update(keys, dt, this.soundManager);
                this.player.draw();

                // Bullet Firing
                if (keys["Space"] && !this.lastSpaceBar) {
                    // Spawn bullet at player
                    const bullet = new Bullet(this.player.x, this.player.y, this.player.angle, this.player.hitboxActive);
                    this.bullets.push(bullet);
                    this.soundManager.playSound('shoot');
                }

                this.lastSpaceBar = keys["Space"];

                // Draw bullets
                for (let i = this.bullets.length -1; i>= 0; i--) {
                    this.bullets[i].update(dt);
                    this.bullets[i].draw();

                    // Get rid of expired bullets
                    if (this.bullets[i].dur <= 0) {
                        this.bullets.splice(i, 1);
                    }
                }

                // Roiods
                this.updateRoids(dt);
                this.drawRoids();

                // Check Wave complete
                this.checkWaveComplete();
                this.drawWaveInfo();

                requestAnimationFrame(this.draw);
            }
        }

        // =============================
        // Start game
        // =============================
        const game = new GameLoop();
        requestAnimationFrame(game.draw);
    </script>
</body>
</html>
